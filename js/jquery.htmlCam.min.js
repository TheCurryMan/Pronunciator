/*
 * jQuery htmlCam
 * Version 0.1 (@edouardkombo / breezeframework.com)
 * https://github.com/edouardkombo/jquery-htmlCam
 *
 * Activate webcam, record audio and videos directly in html5 and javascript, no flash.
 *
 * Copyright (c) 2014 Edouard Kombo (@edouardkombo / breezeframework.com)
 * Dual licensed under the MIT and GPL licenses.
*/
(function(e){e.htmlCam=function(t){function b(e){if(n.startCam){r.src=window.URL.createObjectURL(e);r.attr({src:window.URL.createObjectURL(e)});f=e}if(n.enableAudioStream){var t=l.createMediaStreamSource(e);console.log("Media stream created.");var i=l.createGain();i.gain.value=0;t.connect(i);i.connect(l.destination);console.log("Input connected to muted gain node connected to audio context destination.");h=new E(t);console.log("Recorder initialised.")}}function S(){e("canvas").attr({width:r.width(),height:r.height()});u.width=r.width();u.height=r.height();a.drawImage(r[0],0,0,r.width(),r.height());var t=u[0].toDataURL("image/"+n.snapShotFormat,n.pictureQuality);if(e.isFunction(n.snapshotOnComplete)){n.snapshotOnComplete.call(this,t)}if(n.snapshotFlashScreen!==false){e("body").fadeTo(n.snapshotFlashScreen.fadeIn,n.snapshotFlashScreen.fadeInSpeed).fadeTo(n.snapshotFlashScreen.fadeOut,n.snapshotFlashScreen.fadeOutSpeed)}if(window.HTMLAudioElement){i=new Audio("");if(e.inArray(o,s)!==-1){if(i.canPlayType("audio/"+o+"")){i=new Audio(n.snapshotSound);i.play();console.log(i);if(n.stop===true){console.log(i.stop())}}else{alert("Error! Unable to play "+n.snapshotSound+". Please check extension.")}}else{console.log("Your file format is not recognized as audio file!")}}else{console.log("HTML5 Audio is not supported by your browser!")}}function x(){h&&h.record();console.log("Recording audio...")}function T(){h&&h.stop();N();h.clear();console.log("Stop Recording audio!")}function N(){h&&h.exportWAV(function(e){C(e,n.onAudioComplete)})}function C(t,r){if(e.isFunction(r)){r.call(this,t,n.readyToEncode)}}function k(){function t(n){v=requestAnimationFrame(t);e("canvas").attr({width:r.width(),height:r.height()});a.drawImage(r[0],0,0,r.width(),r.height());var i=u[0].toDataURL("image/webp",1);y.push(i)}y=[];m=Date.now();console.log("Recording video...");v=requestAnimationFrame(t)}function L(){cancelAnimationFrame(v);g=Date.now();console.log("frames captured: "+y.length+" => "+(g-m)/1e3+"s video");var e=new Whammy.Video(15);var t=Whammy.fromImageArray(y,n.videoFrameRate);C(t,n.onVideoComplete)}var n={startCam:true,pictureQuality:1,enableSnapshot:false,snapshotFlashScreen:false,snapshotButton:"",snapshotSound:"",snapShotFormat:"jpeg",snapshotOnComplete:"",recordingTime:0,recordAudioAndVideo:false,enableVideoStream:false,enableAudioStream:false,recorderWorkerPath:"",onAudioComplete:"null",audioTriggerButtons:"",onVideoComplete:"null",videoTriggerButtons:"",videoFrameRate:500/60,encode:""};if(t){e.extend(n,t)}var r=e("video").length>0?e("video"):e("<video>").attr({id:"video"}).appendTo("body");r.autoplay=true;n.recordingTime=n.recordingTime*1e3;var i="";var s=["ogg","mp3","wav","mp4","wma"];var o=n.snapshotSound!==""?n.snapshotSound.split(".").pop():"";var u=e("canvas").length>0?e("canvas"):e("<canvas>").attr({id:"canvas"}).appendTo("body");var a=u[0].getContext("2d");var f=null;var l;var c=e("audio").length>0?e("audio"):e("<audio>").attr({id:"audio"}).appendTo("body");var h;var p;var d=document.title;var v=null;var m=null;var g=null;var y=[];e("canvas").attr({width:r.width(),height:r.height()});if(n.recordAudioAndVideo===true){n.enableAudioStream=true;n.enableVideoStream=true}if(n.enableSnapshot){e(n.snapshotButton).click(function(){e(n.snapshotButton).hide();e(n.audioTriggerButtons[0]).hide();e(n.audioTriggerButtons[1]).hide();e(n.videoTriggerButtons[0]).hide();e(n.videoTriggerButtons[1]).hide();S();e(n.snapshotButton).show();if(n.recordAudioAndVideo){e(n.videoTriggerButtons[0]).hide()}else{e(n.audioTriggerButtons[0]).show()}e(n.videoTriggerButtons[0]).show()})}if(n.enableAudioStream){if(e.isArray(n.audioTriggerButtons)===true){if(n.recordAudioAndVideo===true){e(n.audioTriggerButtons[0]).hide();e(n.audioTriggerButtons[1]).hide()}else{e(n.audioTriggerButtons[0]).show();e(n.audioTriggerButtons[1]).hide()}e(n.audioTriggerButtons[0]).click(function(){if(n.recordingTime>0){x();e(n.audioTriggerButtons[0]).hide();var t=setInterval(function(){T();clearInterval(t);e(n.audioTriggerButtons[0]).show()},n.recordingTime)}else{x();e(n.audioTriggerButtons[0]).hide();e(n.audioTriggerButtons[1]).show()}});e(n.audioTriggerButtons[1]).click(function(){T();e(n.audioTriggerButtons[1]).hide();e(n.audioTriggerButtons[0]).show()})}else{alert("Audio buttons specification have to be array")}}if(n.enableVideoStream){if(e.isArray(n.videoTriggerButtons)===true){e(n.videoTriggerButtons[0]).show();e(n.videoTriggerButtons[1]).hide();e(n.videoTriggerButtons[0]).click(function(){e(n.snapshotButton).hide();e("video").hide();e("window").focusout();if(n.recordingTime>0){if(n.recordAudioAndVideo===true){x()}k();e(n.videoTriggerButtons[0]).hide();var t=setTimeout(function(){if(n.recordAudioAndVideo===true){e.when(T(),e(n.videoTriggerButtons[0]).show(),e(n.snapshotButton).show(),clearTimeout(t)).then(function(){L();n.encode.call(this)})}else{L();clearInterval(t);e(n.videoTriggerButtons[0]).show();e(n.snapshotButton).show()}},n.recordingTime)}else{k();if(n.recordAudioAndVideo===true&&n.enableAudioStream===true){x()}e(n.videoTriggerButtons[0]).hide();e(n.videoTriggerButtons[1]).show()}});e(n.videoTriggerButtons[1]).click(function(){if(n.recordAudioAndVideo===true&&n.enableAudioStream===true&&n.recordingTime<=0){T()}L();e(n.videoTriggerButtons[1]).hide();e(n.videoTriggerButtons[0]).show()})}else{alert("Video buttons specification have to be array")}}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.AudioContext=window.AudioContext||window.webkitAudioContext;window.URL=window.URL||window.webkitURL;window.onload=function(){if(n.enableAudioStream){try{l=new AudioContext;console.log("Audio context set up.");console.log("navigator.getUserMedia "+(navigator.getUserMedia?"available.":"not present!"))}catch(t){alert("No web audio support in this browser!")}}navigator.getUserMedia({audio:n.enableAudioStream,video:n.startCam},b,function(e){console.log("No live audio input or video stream: "+e)})};var w=n.recorderWorkerPath;var E=function(e,t){var n=t||{};var r=n.bufferLen||4096;this.context=e.context;this.node=this.context.createJavaScriptNode(r,2,2);var i=new Worker(n.workerPath||w);i.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}});var s=false,o;this.node.onaudioprocess=function(e){if(!s)return;i.postMessage({command:"record",buffer:[e.inputBuffer.getChannelData(0),e.inputBuffer.getChannelData(1)]})};this.configure=function(e){for(var t in e){if(e.hasOwnProperty(t)){n[t]=e[t]}}};this.record=function(){s=true};this.stop=function(){s=false};this.clear=function(){i.postMessage({command:"clear"})};this.getBuffer=function(e){o=e||n.callback;i.postMessage({command:"getBuffer"})};this.exportWAV=function(e,t){o=e||n.callback;t=t||n.type||"audio/wav";if(!o)throw new Error("Callback not set");i.postMessage({command:"exportWAV",type:t})};i.onmessage=function(e){var t=e.data;o(t)};e.connect(this.node);this.node.connect(this.context.destination)};window.Recorder=E;return this}})(jQuery)



